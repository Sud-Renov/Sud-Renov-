<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Admin Planning</title>
<style>
  body { font-family: Arial, sans-serif; display:flex; gap:20px; margin:0; background:#1e3a8a; color:#fff; }
  .sidebar { width:260px; background:#1e40af; padding:15px; border-radius:8px; }
  .chip { background:#2563eb; color:#fff; padding:8px 12px; margin:5px 0; border-radius:6px; cursor:grab; display:flex; align-items:center; justify-content:space-between; }
  .chip:active { cursor:grabbing; }
  .site { background:#1e40af; border-radius:8px; padding:10px; margin-bottom:15px; }
  .droppable { min-height:40px; border:2px dashed #93c5fd; padding:8px; border-radius:6px; margin-top:8px; }
  .droppable.dragover { background:#2563eb; }
  .tag { background:#93c5fd; border-radius:999px; padding:4px 8px; margin:4px; display:inline-flex; align-items:center; color:#000; }
  .removeBtn, .inlineEditBtn { margin-left:6px; background:transparent; border:none; cursor:pointer; font-weight:bold; }
  .removeBtn { color:#ff4444; }
  .inlineEditBtn { color:#fff; }
  button { background:#2563eb; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-top:5px; }
  button:hover { background:#1e40af; }
  input { display:block; margin:4px 0; padding:6px 8px; width:100%; border-radius:6px; border:none; }
</style>
</head>
<body>

<div class="sidebar">
  <h3>Ouvriers</h3>
  <input id="workerName" placeholder="Nom de l'ouvrier">
  <button type="button" onclick="addWorker()">Ajouter</button>
  <div id="workersList"></div>

  <h3>T√¢ches</h3>
  <input id="taskName" placeholder="Nom de la t√¢che">
  <button type="button" onclick="addTask()">Ajouter</button>
  <div id="tasksList"></div>

  <h3>JSON</h3>
  <button type="button" onclick="importJSON()">üìÇ Importer JSON</button>
  <button type="button" onclick="exportJSON()">‚¨áÔ∏è Exporter JSON</button>
</div>

<div class="main" style="flex:1; padding:20px;">
  <h2>Chantiers du jour</h2>
  <input id="siteTitleFr" placeholder="Titre (FR)">
  <input id="siteAddressFr" placeholder="Adresse/Ville (FR)">
  <input id="sitePhoto" placeholder="Chemin photo (ex: images/chantier.jpg)">
  <input id="siteNotes" placeholder="Annotations (ex: pose ossature plafond)">
  <button id="addSiteBtn" type="button" onclick="addSite()">Ajouter chantier</button>

  <div id="sitesGrid"></div>
</div>

<script>

<script>
// --- D√©but du script JavaScript ---

let workers = [];
let tasks = [];
let sites = [];

function makeChip(type, name) {
  const div = document.createElement("div");
  div.className = "chip";
  div.draggable = true;
  div.dataset.type = type;
  div.dataset.name = name;

  const label = document.createElement("span");
  label.textContent = (type === "ouvrier" ? "üë∑ " : "üõ†Ô∏è ") + name;
  div.appendChild(label);

  const editBtn = document.createElement("button");
  editBtn.textContent = "‚úèÔ∏è";
  editBtn.className = "inlineEditBtn";
  editBtn.onclick = () => {
    const oldName = div.dataset.name;
    const newName = prompt("Nouveau nom :", oldName);
    if (newName && newName.trim()) {
      div.dataset.name = newName.trim();
      label.textContent = (type === "ouvrier" ? "üë∑ " : "üõ†Ô∏è ") + div.dataset.name;
      sites.forEach(s => s.crew.forEach(c => {
        if (c.type === type && c.name === oldName) c.name = newName.trim();
      }));
      renderSites();
    }
  };
  div.appendChild(editBtn);

  div.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", JSON.stringify({ type: div.dataset.type, name: div.dataset.name }));
  });

  return div;
}

function addWorker() {
  const input = document.getElementById("workerName");
  const name = input.value.trim();
  if (!name) return;
  if (!workers.includes(name)) workers.push(name);
  document.getElementById("workersList").appendChild(makeChip("ouvrier", name));
  input.value = "";
}

function addTask() {
  const input = document.getElementById("taskName");
  const name = input.value.trim();
  if (!name) return;
  if (!tasks.includes(name)) tasks.push(name);
  document.getElementById("tasksList").appendChild(makeChip("tache", name));
  input.value = "";
}

function addSite() {
  const titleFr = document.getElementById("siteTitleFr").value.trim();
  const addressFr = document.getElementById("siteAddressFr").value.trim();
  const photo = document.getElementById("sitePhoto").value.trim();
  const notes = document.getElementById("siteNotes").value.trim();

  if (!titleFr || !addressFr) {
    alert('Merci de remplir au minimum "Titre (FR)" et "Adresse/Ville (FR)".');
    return;
  }

  const id = "site" + Math.random().toString(36).slice(2,9);
  sites.push({
    id,
    title: { fr: titleFr },
    address: { fr: addressFr },
    photo,
    notes,
    crew: [],
    status: "ok"
  });

  document.getElementById("siteTitleFr").value = "";
  document.getElementById("siteAddressFr").value = "";
  document.getElementById("sitePhoto").value = "";
  document.getElementById("siteNotes").value = "";

  renderSites();
}

function renderSites() {
  const grid = document.getElementById("sitesGrid");
  grid.innerHTML = "";

  sites.forEach(site => {
    const card = document.createElement("div");
    card.className = "site";

    const header = document.createElement("div");
    header.innerHTML = `
      <strong>${site.title.fr}</strong><br>
      üìç ${site.address.fr}<br>
      üìù ${site.notes || ""}<br>
    `;
    card.appendChild(header);

    const dropzone = document.createElement("div");
    dropzone.className = "droppable";
    dropzone.dataset.id = site.id;
    card.appendChild(dropzone);

    dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("dragover"); });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      const data = JSON.parse(e.dataTransfer.getData("text/plain"));

      let chantierTrouve = null;
      let villeTrouvee = null;
      for (const s of sites) {
        if (s.id !== site.id) {
          for (const c of s.crew) {
            if (c.type === data.type && c.name === data.name) {
              chantierTrouve = s.title.fr;
              villeTrouvee = s.address.fr;
              break;
            }
          }
        }
        if (chantierTrouve) break;
      }

      if (chantierTrouve) {
        alert(`‚ö†Ô∏è Attention, "${data.name}" est d√©j√† affect√© au chantier "${chantierTrouve}" √† "${villeTrouvee}" !`);
        return;
      }

      site.crew.push({ type: data.type, name: data.name });
      renderSites();
    });

    site.crew.forEach((c, idx) => {
      const tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = (c.type === "ouvrier" ? "üë∑ " : "üõ†Ô∏è ") + c.name;

      const removeBtn = document.createElement("button");
      removeBtn.textContent = "‚ùå";
      removeBtn.className = "removeBtn";
      removeBtn.onclick = () => {
        site.crew.splice(idx, 1);
        renderSites();
      };

      tag.appendChild(removeBtn);
      dropzone.appendChild(tag);
    });

    const editSiteBtn = document.createElement("button");
    editSiteBtn.textContent = "‚úèÔ∏è √âditer chantier";
    editSiteBtn.onclick = () => {
      const newTitle = prompt("Nouveau titre :", site.title.fr);
      const newAddress = prompt("Nouvelle adresse/ville :", site.address.fr);
      const newPhoto = prompt("Nouvelle photo :", site.photo);
      const newNotes = prompt("Nouvelles annotations :", site.notes || "");
      if (newTitle && newTitle.trim()) site.title.fr = newTitle.trim();
      if (newAddress && newAddress.trim()) site.address.fr = newAddress.trim();
      if (newPhoto && newPhoto.trim()) site.photo = newPhoto.trim();
      if (newNotes && newNotes.trim()) site.notes = newNotes.trim();
      renderSites();
    };
    card.appendChild(editSiteBtn);

    grid.appendChild(card);
  });
}

function exportJSON() {
  try {
    const json = JSON.stringify(sites, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "planning.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    alert("‚úÖ Export effectu√© (planning.json t√©l√©charg√©).");
  } catch (err) {
    alert("‚ùå Erreur export : " + err.message);
    console.error(err);
  }
}

function importJSON() {
  fetch("planning.json?ts=" + Date.now())
    .then(r => {
      if (!r.ok) throw new Error("Impossible de charger planning.json");
      return r.json();
    })
    .then(data => {
      if (!Array.isArray(data)) throw new Error("Format JSON invalide (attendu: tableau de chantiers).");
      sites = data;

      workers = [];
      tasks = [];
      const workersList = document.getElementById("workersList");
      const tasksList = document.getElementById("tasksList");
      workersList.innerHTML = "";
      tasksList.innerHTML = "";

      sites.forEach(site => {
        (site.crew || []).forEach(c => {
          if (c.type === "ouvrier" && !workers.includes(c.name)) {
            workers.push(c.name);
            workersList.appendChild(makeChip("ouvrier", c.name));
          }
          if (c.type === "tache" && !tasks.includes(c.name)) {
            tasks.push(c.name);
            tasksList.appendChild(makeChip("tache", c.name));
          }
        });
      });

      renderSites();
      alert("‚úÖ Planning import√© avec succ√®s !");
    })
    .catch(err => {
      alert("‚ùå Erreur lors de l'import : " + err.message);
      console.error(err);
    });
}

// --- Fin du script JavaScript ---
</script>
</body>
</html>